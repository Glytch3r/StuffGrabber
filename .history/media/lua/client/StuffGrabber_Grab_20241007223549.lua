--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

StuffGrabber = StuffGrabber or {}

function StuffGrabber.isCanGrab(toGrab, dropPoint)
    local rad = StuffGrabber.getRad()
    local pl = getPlayer()
    local stuff = {}
    local cell = pl:getCell()
    local x, y, z = dropPoint:getX(), dropPoint:getY(), dropPoint:getZ()
    local count = 0
    for xDelta = -rad, rad do
        for yDelta = -rad, rad do
            local targSq = cell:getOrCreateGridSquare(x + xDelta, y + yDelta, z)
            for i = 0, targSq:getObjects():size() - 1 do
                local item = targSq:getObjects():get(i)
                if instanceof(item, "IsoWorldInventoryObject") then
                    local name = item:getItem():getFullType()
                    if name and name == toGrab then
                        return true
                    end
                end
            end
        end
    end
    return false
end

function StuffGrabber.isNearDropPoint(dropPoint, itemSq)
    if dropPoint == itemSq then return true end
    local dropX, dropY, dropZ = dropPoint:getX(), dropPoint:getY(), dropPoint:getZ()
    local itemX, itemY, itemZ = itemSq:getX(), itemSq:getY(), itemSq:getZ()
    if itemZ == dropZ then
        if math.abs(itemX - dropX) <= 1 and math.abs(itemY - dropY) <= 1 then
            return true
        end
    end
    return false
end



function StuffGrabber.func(toGrab, dropPoint)
    local rad = StuffGrabber.getRad()
    local pl = getPlayer()
    local inv = pl:getInventory()


    local cell = pl:getCell()
    local x, y, z = dropPoint:getX(), dropPoint:getY(), dropPoint:getZ()


    local maxWeight = (pl:getMaxWeight() + SandboxVars.StuffGrabber.ForceCarryWeight)
    local currentWeight = inv:getCapacityWeight()
    local totalItemWeight = 0
    local itemsToGrab = {}
    local ignored = 0
    local canPickupCount = 0
    local count = 0
    for xDelta = -rad, rad do
        for yDelta = -rad, rad do
            local targSq = cell:getOrCreateGridSquare(x + xDelta, y + yDelta, z)
            for i = 0, targSq:getObjects():size() - 1 do
                local item = targSq:getObjects():get(i)
                if instanceof(item, "IsoWorldInventoryObject") then
                    local name = item:getItem():getFullType()
                    if name and name == toGrab then
                        local itemSq = item:getSquare()
                        if itemSq then
                            count = count + 1
                            if not StuffGrabber.isNearDropPoint(dropPoint, itemSq) then
                                local itemWeight = item:getItem():getActualWeight()
                                totalItemWeight = totalItemWeight + itemWeight
                                if (currentWeight + totalItemWeight) <= maxWeight or pl:isUnlimitedCarry() then
                                    canPickupCount = canPickupCount + 1
                                    table.insert(itemsToGrab, item)
                                end
                            else
                                if getCore():getDebug() then
                                    ignored = ignored + 1
                                end
                            end
                        end
                    end
                end
            end
        end
    end

    for _, item in ipairs(itemsToGrab) do
        local targSq = item:getSquare()
        ISTimedActionQueue.add(ISWalkToTimedAction:new(pl, targSq))
        local time = ISWorldObjectContextMenu.grabItemTime(pl, item)
        ISTimedActionQueue.add(ISGrabItemAction:new(pl, item, time))
    end


    if getCore():getDebug() or SandboxVars.StuffGrabber.CountIndicators then
        print('ignored ' .. tostring(ignored))
        local color =  getCore():getGoodHighlitedColor()
        local msg = 'Grabbing [ '..tostring(canPickupCount)..' / '..tostring(count)..' ] '.. tostring(toGrab)
        pl:setHaloNote(tostring(msg), color:getR()*255, color:getG()*255, color:getB()*255, 200)
    end

    local shouldGoBack = false
    if (count - ignored) > canPickupCount then shouldGoBack = true end

    ISTimedActionQueue.add(ISWalkToTimedAction:new(pl, dropPoint))
    ISTimedActionQueue.add(StuffGrabber_Act:new(pl, dropPoint, toGrab, shouldGoBack))
    ISInventoryPage.renderDirty = true
end




--[[
print( getPlayer():getInventoryWeight())
print( getPlayer():getInventory():getCapacityWeight())
print( getPlayer():getMaxWeight())
 ]]