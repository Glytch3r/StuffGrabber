--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]


-----------------------            ---------------------------
--[[
	PsychoZedMod.playSFX(zed, PsychoZedMod.getCrySfx())
	PsychoZedMod.playSFX(zed, PsychoZedMod.getLaughSfx())
	PsychoZedMod.playSFX(zed, PsychoZedMod.getScreamSfx())
 ]]
-----------------------            ---------------------------


PsychoZedMod = PsychoZedMod or {}


 function PsychoZedMod.setSprinter(zed)
	local sandOpt = getSandboxOptions()
	local zSpeed = sandOpt:getOptionByName("ZombieLore.Speed"):getValue()
	--zed:setWalkType("sprint"..tostring(PsychoZedMod.getWalkNum(zed)));

	if PsychoZedMod.isNight() then
		zed:setWalkType("sprint2");
	else
		zed:setWalkType("sprint1");
	end
	sandOpt:set("ZombieLore.Speed", 1)
	zed:makeInactive(true)
	zed:makeInactive(false)
	zed:DoZombieStats()
	sandOpt:set("ZombieLore.Speed", zSpeed)
end

function PsychoZedMod.setWalk(zed)
	local sandOpt = getSandboxOptions()
	local zSpeed = sandOpt:getOptionByName("ZombieLore.Speed"):getValue()
	zed:setWalkType('1');
	sandOpt:set("ZombieLore.Speed", 2)
	zed:makeInactive(true)
	zed:makeInactive(false)
	zed:DoZombieStats()
	sandOpt:set("ZombieLore.Speed", zSpeed)
end


function PsychoZedMod.setStats(zed)
    if zed and PsychoZedMod.isPsychoZed(zed) then
        if zed:getModData()['PsychoZed_Init'] == nil then
            local sandOpt = getSandboxOptions()
            local zCog = sandOpt:getOptionByName("ZombieLore.Cognition"):getValue()
            local zTough = sandOpt:getOptionByName("ZombieLore.Toughness"):getValue()
            local zStr = sandOpt:getOptionByName("ZombieLore.Strength"):getValue()

            local zMem = sandOpt:getOptionByName("ZombieLore.Memory"):getValue()
            local zSee = sandOpt:getOptionByName("ZombieLore.Sight"):getValue()
            local zHear = sandOpt:getOptionByName("ZombieLore.Hearing"):getValue()



            sandOpt:set("ZombieLore.Cognition",1) -- 1 navigate + doors
            sandOpt:set("ZombieLore.Toughness",1) 	-- 1 tough
            sandOpt:set("ZombieLore.Strength",1) -- 1 superhuman

            sandOpt:set("ZombieLore.Memory",4) --none
            sandOpt:set("ZombieLore.Sight",3) -- poor
            sandOpt:set("ZombieLore.Hearing",2) -- normal
            -----------------------            ---------------------------
            PsychoZedMod.setTurnSpeed(zed, 0)
            -----------------------            ---------------------------

            zed:getModData()['PsychoZed_Init'] = true
            zed:setVariable('isPsychoZed', 'true')
            -----------------------            ---------------------------

            zed:makeInactive(true);
            zed:makeInactive(false);
            zed:DoZombieStats()

            sandOpt:set("ZombieLore.Cognition", zCog)
            sandOpt:set("ZombieLore.Toughness", zTough)
            sandOpt:set("ZombieLore.Strength", zStr)

            sandOpt:set("ZombieLore.Memory", zMem)
            sandOpt:set("ZombieLore.Sight", zSee)
            sandOpt:set("ZombieLore.Hearing", zHear)
            --getSandboxOptions():toLua()
        end
    end
end
--the player thinks that the zed is a real human so they dont want to harm it, just dont know what to name it
function PsychoZedMod.setSympathy(zed, bool)
	if not PsychoZedMod.isPsychoZed(zed) then return end
	if bool == false then
		if not zed:isShootable() then
			zed:setShootable(true)
		end
		if zed:avoidDamage() then
			zed:setAvoidDamage(false)
		end
	else
		if SandboxVars.PsychoZed.PlayerSympathy then
			if not zed:avoidDamage() then
				zed:setAvoidDamage(true)
			end
			if zed:isShootable() then
				zed:setShootable(false)
			end
		end
	end
end
function PsychoZedMod.isSympathy(zed)
	if PsychoZedMod.isNight() then return false end
	if PsychoZedMod.isPsychoZed(zed) then
		if zed:avoidDamage() and not zed:isShootable() then
			return true
		end
	end
	return false
end


function PsychoZedMod.isShouldIgnore(pl, zed)
	if PsychoZedMod.isNight() then return false end
	if SandboxVars.PsychoZed.PlayerSympathy and PsychoZedMod.isCrying(zed) then
		return true
	else
		return false
	end
end

-- SandboxVars.PsychoZed.PlayerSympathy if this is true then psycho shouldnt stop crying and just ignore player
-- it shouldnt get hurt when its attacked
-- but if SandboxVars.PsychoZed.PlayerSympathy is set to false then it should go agro when a player attacks it


function PsychoZedMod.StateHandler(zed)
    if not zed then return end
	local pl = getPlayer(); if not pl then return end
	if not PsychoZedMod.isPsychoZed(zed) then return end
	if (pl:IsAiming() or pl:isAimKeyDown()) and PsychoZedMod.isTarg(pl, zed) then
		if PsychoZedMod.isCrying(zed) then
			if SandboxVars.PsychoZed.PlayerSympathy then
				if not PsychoZedMod.isSympathy(zed) then
					PsychoZedMod.setSympathy(zed, true)
				end
				pl:nullifyAiming()
				pl:setIgnoreAimingInput(true)
			end
		else
			if PsychoZedMod.isSympathy(zed) then
				PsychoZedMod.setSympathy(zed, false)
			end
			pl:setIgnoreAimingInput(false)
		end
	else
		if PsychoZedMod.isSympathy(zed) then
			PsychoZedMod.setSympathy(zed, false)
		end
		pl:setIgnoreAimingInput(false)
	end


    if PsychoZedMod.isNight() then
		if  PsychoZedMod.isCrying(zed) then
			PsychoZedMod.setCry(zed, false)
		end
		if PsychoZedMod.isAggro(zed) then
			if not PsychoZedMod.isSprinter(zed) then
				PsychoZedMod.setSprinter(zed)
			end
		else
			if PsychoZedMod.isSprinter(zed) then
				PsychoZedMod.setWalk(zed)
			end
		end

		local tSpeed =  SandboxVars.PsychoZed.TurnSpeed or 1.5
		PsychoZedMod.setTurnSpeed(zed, tSpeed)
	end
	if PsychoZedMod.isDay() then
		if not PsychoZedMod.isAggro(zed) then
			if not PsychoZedMod.isCrying(zed) then
				PsychoZedMod.setCry(zed, true)
			end
		end
		if PsychoZedMod.isAggro(zed) then
			if PsychoZedMod.isShouldIgnore(pl, zed) then
				PsychoZedMod.setIgnore(zed, pl)
			else
				PsychoZedMod.setCry(zed, false)
			end
		end
	end

	if PsychoZedMod.isCrying(zed) then
		PsychoZedMod.setTurnSpeed(zed, 0)
	else
		local tSpeed =  SandboxVars.PsychoZed.TurnSpeed or 1.5
		PsychoZedMod.setTurnSpeed(zed, tSpeed)
	end

	if not PsychoZedMod.isShouldIgnore(pl, zed) and not PsychoZedMod.isSprinter(zed) and not PsychoZedMod.isCrying(zed) then
		PsychoZedMod.setSprinter(zed)
	end
end
Events.OnZombieUpdate.Remove(PsychoZedMod.StateHandler)
Events.OnZombieUpdate.Add(PsychoZedMod.StateHandler)


-----------------------            ---------------------------

function PsychoZedMod.setStatsToAll()
    local zombies = getCell():getZombieList()
    if not getCell() or not zombies then return end
    for i = 0, zombies:size() - 1 do
        local zed = zombies:get(i)
        if zed and PsychoZedMod.isPsychoZed(zed) then
            if zed:getModData()['PsychoZed_Init'] ~= nil then
                zed:getModData()['PsychoZed_Init'] = nil
            end
            PsychoZedMod.setStats(zed)
        end
    end
end

--[[ function PsychoZedMod.isSprinter(zed)
	local walk = zed:getVariableString("zombieWalkType")
    return (luautils.stringStarts(walk, "sprint") or tostring(zed.walkType:contains('sprint')))
end
 ]]
function PsychoZedMod.isSprinter(zed)
	if zed.walkType then
		if tostring(zed.walkType:contains('sprint')) then
			if PsychoZedMod.isNight() then
				if tonumber(PsychoZedMod.getWalkNum(zed)) == 2 then
					return true
				end
			else
				if tonumber(PsychoZedMod.getWalkNum(zed)) == 1 then
					return true
				end
			end
		end
	end
	return false
end

function PsychoZedMod.getWalkType(zed)
	return zed:getVariableString("zombieWalkType")
end

function PsychoZedMod.getWalkNum(zed)
	return tonumber(PsychoZedMod.getWalkType(zed):match("%d+"))
end

function PsychoZedMod.isCrying(zed)
	return  zed:isForceEatingAnimation()
end

function PsychoZedMod.setTurnSpeed(zed, int)
	if int == nil then
		int = 0
	end
	if zed:getTurnDelta() ~= int  then
		zed:setTurnDelta(int)
	end
end

function PsychoZedMod.setCry(zed, bool)
	if bool == true then
		if not PsychoZedMod.isCrying(zed) then
			--zed:changeState(ZombieGetDownState.instance())
			zed:setForceEatingAnimation(true)
		end
		if zed:isCanWalk() then
			zed:setCanWalk(false)
		end
		PsychoZedMod.setTurnSpeed(zed, 0)
	else
		local tSpeed =  SandboxVars.PsychoZed.TurnSpeed or 1
		PsychoZedMod.setTurnSpeed(zed, tSpeed)
		PsychoZedMod.setStand(zed)
	end
end

function PsychoZedMod.isAggro(zed)
	return zed:getTarget() ~= nil
end




function PsychoZedMod.setIgnore(zed, pl)
	if PsychoZedMod.isAggro(zed) then
		zed:clearAggroList()
		zed:setTarget(nil)
	end
end

function PsychoZedMod.goAggro(zed, pl)
	if zed:getTarget() ~= pl then
		zed:setTarget(pl)
	end
	if not zed:isCanWalk() then
		zed:setCanWalk(true)
	end
	if zed:isOnFloor() then
		PsychoZedMod.setStand(zed)
	end
end

function PsychoZedMod.isMoving(zed)
	return zed:isCurrentState(WalkTowardState.instance()) or zed:isCurrentState(WalkTowardNetworkState.instance()) or zed:isCurrentState(PathFindState.instance())
end

function PsychoZedMod.isLaughing(zed)
	return PsychoZedMod.isAggro(zed) and not PsychoZedMod.isCrying(zed)
end



--if zed:isCurrentState(AttackNetworkState.instance()) or zed:isCurrentState(AttackNetworkState.instance()) then end
--PsychoZedMod.isWithinRange(pl, zed, range) and PsychoZedMod.isClosestPl(pl, zed)


-----------------------            ---------------------------


function PsychoZedMod.getState(zed)
    return zed:getCurrentState()
end

function PsychoZedMod.setStand(zed)

    if not zed:isCanWalk() then
        zed:setCanWalk(true)
    end
    if zed:isFakeDead() or zed:isCurrentState(FakeDeadZombieState.instance())  then
        zed:setFakeDead(false)
    end
    if zed:isForceEatingAnimation() then
        zed:setForceEatingAnimation(false)
    end
    if zed:isSitAgainstWall() then
        zed:setSitAgainstWall(false)
    end
    if zed:isCrawling() then
        zed:toggleCrawling()
		zed:setCrawler(false)
    end
	if zed:isOnFloor() then
		zed:changeState(ZombieGetUpState.instance())
	end
	zed:makeInactive(true)
	zed:makeInactive(false)
	zed:DoZombieStats()
end


-----------------------            ---------------------------

